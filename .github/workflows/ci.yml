# Normitri CI — Build and test on Linux with GCC and Clang (C++23, Conan, OpenCV, GTest)
# Trigger-based only: run from Actions tab → CI → Run workflow (uses selected ref, e.g. branch or PR).

name: CI

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: ${{ matrix.compiler }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04]
        compiler: [gcc, clang]
        include:
          - compiler: gcc
            cc: gcc-13
            cxx: g++-13
          - compiler: clang
            cc: clang-18
            cxx: clang++-18

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install compiler (${{ matrix.compiler }})
        run: |
          sudo apt-get update -qq
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            sudo apt-get install -y gcc-13 g++-13
          else
            # Clang uses libstdc++; install g++-13 so libstdc++13 (with C++23 std::expected) is available
            sudo apt-get install -y clang-18 g++-13
            # Make GCC 13 the default so Clang picks up libstdc++13 (required for std::expected)
            sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
            sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100
            sudo update-alternatives --set gcc /usr/bin/gcc-13
            sudo update-alternatives --set g++ /usr/bin/g++-13
          fi
          echo "CC=${{ matrix.cc }}" >> $GITHUB_ENV
          echo "CXX=${{ matrix.cxx }}" >> $GITHUB_ENV

      - name: Install CMake and system deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y cmake build-essential python3-pip \
            libva-dev libvdpau-dev libxkbcommon-dev libwayland-dev \
            libxrandr-dev libgl1-mesa-dev libdrm-dev

      - name: Set up Python and Conan
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Conan
        run: pip install conan

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan2/p
          key: conan-${{ runner.os }}-${{ hashFiles('conanfile.txt') }}
          restore-keys: conan-${{ runner.os }}-

      - name: Conan profile detect (compiler)
        run: |
          conan profile detect --force
          conan profile show

      - name: Install dependencies (Conan)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          conan install . --output-folder=build --build=missing \
            -s compiler.cppstd=23 \
            -c tools.system.package_manager:mode=install

      - name: Configure and build
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            export NORMITRI_CMAKE_ARGS="-DNORMITRI_WARNINGS_AS_ERRORS=ON -DCMAKE_CXX_FLAGS=--gcc-toolchain=/usr -DCMAKE_EXE_LINKER_FLAGS=--gcc-toolchain=/usr"
          else
            export NORMITRI_CMAKE_ARGS="-DNORMITRI_WARNINGS_AS_ERRORS=ON"
          fi
          bash scripts/build_nomitri.sh build

      - name: Run tests
        run: |
          ctest --test-dir build --output-on-failure -C Release

      - name: Summary
        run: |
          echo "## ${{ matrix.compiler }} on ${{ matrix.os }} — OK" >> $GITHUB_STEP_SUMMARY
          echo "- Compiler: ${{ matrix.cc }} / ${{ matrix.cxx }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ctest passed" >> $GITHUB_STEP_SUMMARY
